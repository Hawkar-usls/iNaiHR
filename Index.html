<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#05000a">
    <title>iNaiHR: AI Nexus</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #05000a;
            --bg-pulse: #120024;
            --c-primary: #d300ff;
            --c-accent: #00e5ff;
            --c-white: #e0ccff;
            --c-red: #ff2a6d;
            --neuron-core: var(--c-primary);
            --neuron-aura: #9d00ff;
            --synapse-off: rgba(211, 0, 255, 0.2);
            --grid-line: rgba(211, 0, 255, 0.08);
            --glass-border: rgba(211, 0, 255, 0.25);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif; color: var(--c-white);
            -webkit-user-select: none; user-select: none; touch-action: none;
        }

        /* ATMOSPHERE */
        #neural-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, var(--bg-pulse), var(--bg-dark));
            z-index: 0; animation: pulse-bg 8s infinite alternate ease-in-out; pointer-events: none;
        }
        @keyframes pulse-bg { 0% { opacity: 0.7; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

        #particles, #grid-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #particles { z-index: 0; opacity: 0.5; }
        #grid-bg {
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px; opacity: 1; z-index: 1;
        }
        .particle { position: absolute; background: var(--c-primary); border-radius: 50%; opacity: 0.6; animation: float 20s infinite linear; box-shadow: 0 0 10px var(--c-primary); }
        @keyframes float { 0% { transform: translateY(0) translateX(0); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-100vh) translateX(20px); opacity: 0; } }

        /* UI */
        #logo {
            position: absolute; top: 30px; left: 30px; z-index: 10;
            font-family: 'Orbitron', sans-serif; font-size: 1.6rem; letter-spacing: 3px;
            color: rgba(255,255,255,0.2); pointer-events: none;
            padding-top: env(safe-area-inset-top);
            text-shadow: 0 0 20px rgba(211, 0, 255, 0.2);
        }
        #logo span.i { color: var(--c-accent); }
        #logo span.ai { color: var(--c-primary); text-shadow: 0 0 15px var(--c-primary); }
        #logo span.hr { color: rgba(255,255,255,0.5); font-weight: 400; font-size: 1.2rem; }

        .ui-group {
            position: absolute; top: 40px; right: 30px; z-index: 10;
            display: flex; gap: 10px; padding-top: env(safe-area-inset-top);
        }
        .ui-btn {
            background: rgba(20, 0, 40, 0.6); border: 1px solid var(--glass-border);
            color: var(--c-primary); backdrop-filter: blur(12px);
            padding: 8px 16px; border-radius: 4px;
            font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .ui-btn:active { transform: scale(0.95); color: white; border-color: white; }
        
        #btn-synth { border-color: var(--c-accent); color: #000; background: var(--c-accent); box-shadow: 0 0 20px rgba(0, 229, 255, 0.4); opacity: 0.3; pointer-events: none; }
        #btn-synth.active { opacity: 1; pointer-events: auto; }
        #btn-synth.loading { animation: pulse-synth 1s infinite; }
        @keyframes pulse-synth { 0% { box-shadow: 0 0 10px var(--c-accent); } 50% { box-shadow: 0 0 30px var(--c-accent); } 100% { box-shadow: 0 0 10px var(--c-accent); } }

        #main-btn {
            position: absolute; bottom: calc(40px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
            width: 72px; height: 72px; z-index: 100; border-radius: 50%; border: none;
            background: radial-gradient(circle at 50% 50%, rgba(40, 0, 60, 0.8), rgba(0,0,0,0.9));
            box-shadow: 0 0 0 1px var(--glass-border), 0 0 40px rgba(211, 0, 255, 0.2);
            backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
        }
        #main-btn::after { content: '+'; font-size: 32px; font-weight: 300; color: var(--c-primary); text-shadow: 0 0 10px var(--c-primary); }
        #main-btn.mode-edit::after { content: '‚úé'; color: white; }
        #main-btn.holding-delete::after { content: '√ó'; color: var(--c-red); }

        .link { fill: none; stroke: var(--synapse-off); stroke-width: 1.5px; }
        .neuron-core { fill: #0a0014; stroke: var(--c-primary); stroke-width: 2px; filter: drop-shadow(0 0 8px var(--c-primary)); }
        .neuron-aura { fill: transparent; stroke: var(--neuron-aura); stroke-width: 1px; opacity: 0.3; filter: blur(4px); }
        .hitbox { fill: transparent; cursor: pointer; }
        .node-group.selected .neuron-core { stroke: var(--c-accent); filter: drop-shadow(0 0 15px var(--c-accent)); }
        text.label { font-family: 'Orbitron', sans-serif; font-size: 12px; fill: rgba(224, 204, 255, 0.7); pointer-events: none; text-anchor: middle; }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            width: 85%; max-width: 320px; padding: 30px; text-align: center;
            background: rgba(20, 0, 30, 0.95); border: 1px solid var(--c-primary); border-radius: 0;
            box-shadow: 0 0 50px rgba(211, 0, 255, 0.1);
        }
        #rename-input {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--c-primary);
            color: var(--c-accent); font-family: 'Orbitron', sans-serif; font-size: 1.4rem;
            text-align: center; padding: 10px; outline: none; margin-bottom: 25px;
        }
    </style>
</head>
<body>

    <div id="neural-bg"></div>
    <div id="particles"></div>
    <div id="grid-bg"></div>

    <div id="logo" class="ui-element"><span class="i">i</span>N<span class="ai">ai</span><span class="hr">HR</span></div>
    
    <div class="ui-group ui-element">
        <button id="btn-synth" class="ui-btn" onclick="synthAI()">SYNTH</button>
        <button class="ui-btn" onclick="clearData()">WIPE</button>
    </div>

    <div id="alert-msg"></div>
    <div id="delete-hint">DISCONNECTING...</div>
    
    <button id="main-btn" class="mode-add ui-element"></button>

    <div id="rename-modal" class="modal-backdrop">
        <div class="modal-content">
            <input type="text" id="rename-input" placeholder="INPUT DATA..." autocomplete="off">
            <button class="modal-btn" onclick="saveRename()">INITIATE</button>
        </div>
    </div>

    <div id="chart"></div>

<script>
    const apiKey = ""; // ‚Üê —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏—à—å —Å–≤–æ–π –∫–ª—é—á Gemini/Claude/Grok, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å
    const isMobile = window.innerWidth < 768;
    const PHYS = { linkDist: isMobile ? 90 : 140, charge: -400, collide: 25 };

    // Particles
    function initParticles() {
        const container = document.getElementById('particles');
        for(let i=0; i<25; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random()*100+'%'; p.style.top = Math.random()*100+'%';
            p.style.width = (Math.random()*2+1)+'px'; p.style.height = p.style.width;
            p.style.animationDuration = (Math.random()*5+5)+'s';
            p.style.animationDelay = -(Math.random()*10)+'s';
            container.appendChild(p);
        }
    }
    initParticles();

    // Data
    function loadData() {
        const saved = localStorage.getItem('inaihr_v1');
        if (saved) return JSON.parse(saved);
        return null;
    }
    const initialData = loadData() || {
        nodes: [ { id: 1, label: "Origin", x: window.innerWidth/2, y: window.innerHeight/2 } ],
        links: []
    };
    let nodes = initialData.nodes;
    let links = initialData.links;

    const width = window.innerWidth, height = window.innerHeight;
    let selectedNode = null; 
    
    const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height);
    const g = svg.append("g");
    const linkGroup = g.append("g").attr("class", "links");
    const impulseGroup = g.append("g").attr("class", "impulses");
    const nodeGroup = g.append("g").attr("class", "nodes");

    const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom).call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(1).translate(-width/2, -height/2));
    
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(PHYS.linkDist))
        .force("charge", d3.forceManyBody().strength(PHYS.charge))
        .force("collide", d3.forceCollide().radius(d => (d.radius||40)+10))
        .force("x", d3.forceX(width/2).strength(0.01))
        .force("y", d3.forceY(height/2).strength(0.01))
        .alphaDecay(0.03);

    // AI Synth
    async function synthAI() {
        if (!selectedNode) return showMsg("SELECT NODE FIRST");
        const btn = document.getElementById('btn-synth');
        btn.disabled = true; btn.classList.add('loading'); btn.innerText = "PROCESSING...";

        const prompt = `Generate 4 related concepts for: "${selectedNode.label}". 
        1. Suggest a fitting emoji for the parent "${selectedNode.label}" (key: "selfEmoji").
        2. Provide 4 children with emoji and text (key: "related").
        Return JSON: { "selfEmoji": "üß†", "related": [{"text": "Thought", "emoji": "üí≠"}] }`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(text);

            if (result.selfEmoji && !/^\p{Extended_Pictographic}/u.test(selectedNode.label))
                selectedNode.label = `${result.selfEmoji} ${selectedNode.label}`;

            let angleStep = (Math.PI * 2) / result.related.length;
            result.related.forEach((c, i) => {
                const angle = (Math.random() * 0.5) + (i * angleStep);
                const newNode = {
                    id: Date.now() + i,
                    label: `${c.emoji} ${c.text}`,
                    x: selectedNode.x + Math.cos(angle) * 120,
                    y: selectedNode.y + Math.sin(angle) * 120,
                    isAI: true
                };
                nodes.push(newNode);
                links.push({ source: selectedNode.id, target: newNode.id });
                setTimeout(() => animateImpulse(selectedNode, newNode), i * 200);
            });

            updateTopology(); simulation.alpha(1).restart(); saveData();
            showMsg(`SYNTHESIZED ${result.related.length} NODES`);
        } catch (e) { console.error(e); showMsg("AI ERROR"); }
        finally { btn.disabled = false; btn.classList.remove('loading'); btn.innerText = "SYNTH"; }
    }

    // Rest of the code (controls, drag, save, etc.) ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª
    // (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ —è –æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—É—é —á–∞—Å—Ç—å synthAI, –æ—Å—Ç–∞–ª—å–Ω–æ–µ 100 % –∫–∞–∫ —Ç—ã –ø—Ä–∏—Å–ª–∞–ª)

    // ‚Ä¶ (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∏–∑ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ ‚Äî –æ–Ω —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å)

    updateButtonState(); updateTopology();
</script>
</body>
</html>
